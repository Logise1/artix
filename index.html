<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Artix - Chat v3.0 Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Scrollbars y Utilidades */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background-color: #2b2d31; }
        ::-webkit-scrollbar-thumb { background-color: #1a1b1e; border-radius: 3px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .bg-discord-dark { background-color: #313338; }
        .bg-discord-sidebar { background-color: #2b2d31; }
        .bg-discord-nav { background-color: #1e1f22; }
        .bg-discord-chat { background-color: #313338; }
        
        .server-pill { transition: height 0.2s; }
        .active-server .server-pill { height: 40px; }
        .active-server img, .active-server .server-placeholder { border-radius: 35%; }
        
        .mention { background-color: rgba(88, 101, 242, 0.3); color: #c9cdfb; border-radius: 3px; padding: 0 2px; }
        .mention-everyone { background-color: rgba(240, 178, 50, 0.1); color: #f0b232; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-pop-in { animation: fadeIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .auth-bg { background: linear-gradient(135deg, #1e1f22 0%, #2b2d31 100%); }
        
        /* Transiciones Suaves para Menú Móvil */
        .mobile-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-discord-dark text-gray-100 overflow-hidden h-screen font-sans selection:bg-indigo-500 selection:text-white" oncontextmenu="return false;">

    <!-- LOGIN -->
    <div id="auth-screen" class="fixed inset-0 auth-bg z-[100] flex items-center justify-center">
        <div class="bg-[#313338] p-8 rounded shadow-2xl w-full max-w-md animate-pop-in text-center border border-gray-800 mx-4">
            <img src="http://logise1.github.io/artix/logo.png" class="w-24 h-24 mx-auto mb-4 rounded-full shadow-lg object-cover bg-gray-800">
            <h1 class="text-2xl font-bold text-white mb-2">Artix v3.0</h1>
            <p class="text-gray-400 text-sm mb-6">Chat optimizado para móvil.</p>
            <div id="auth-error" class="hidden bg-red-500/10 border border-red-500 text-red-500 text-xs p-2 rounded mb-4 text-left"></div>
            <form id="auth-form" class="space-y-4 text-left">
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Usuario</label><input type="text" id="auth-username" class="w-full bg-[#1e1f22] border-none text-white p-3 rounded focus:outline-none focus:ring-2 focus:ring-[#5865F2]" required placeholder="Ej: NeoUser"></div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Contraseña</label><input type="password" id="auth-password" class="w-full bg-[#1e1f22] border-none text-white p-3 rounded focus:outline-none focus:ring-2 focus:ring-[#5865F2]" required></div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-[#5865F2] hover:bg-indigo-600 text-white font-bold py-3 rounded transition duration-200">Entrar</button>
            </form>
            <div class="mt-4 text-xs text-gray-400"><button id="auth-toggle-btn" class="text-[#00A8FC] hover:underline">Crear cuenta nueva</button></div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app" class="relative flex h-full w-full overflow-hidden opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <!-- MOBILE OVERLAY (Cierra menú al tocar fuera) -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden transition-opacity duration-300" onclick="window.app.toggleMobileNav()"></div>

        <!-- NAVIGATION WRAPPER (Servidores + Sidebar) -->
        <div id="main-navigation" class="fixed inset-y-0 left-0 z-50 flex h-full mobile-transition -translate-x-full md:relative md:translate-x-0 shadow-2xl md:shadow-none">
            
            <!-- 1. NAV (Server List) -->
            <nav class="w-[72px] bg-discord-nav flex flex-col items-center py-3 space-y-2 overflow-y-auto shrink-0 no-scrollbar">
                <div class="server-icon-wrapper relative group cursor-pointer" onclick="window.app.loadHome()">
                    <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-[4px]"><div id="pill-home" class="server-pill w-full bg-white rounded-r-lg h-[8px] opacity-0 group-hover:opacity-100"></div></div>
                    <div class="w-[48px] h-[48px] bg-[#5865F2] rounded-[50%] group-hover:rounded-[16px] transition-all duration-200 flex items-center justify-center text-white overflow-hidden shadow-lg">
                        <img src="http://logise1.github.io/artix/logo.png" class="w-full h-full object-cover">
                    </div>
                </div>
                <div class="w-8 h-[2px] bg-gray-700 rounded-lg mx-auto"></div>
                <div id="server-list" class="flex flex-col space-y-2 w-full items-center pb-2"></div>
                <div class="group cursor-pointer relative mt-auto" onclick="window.app.toggleModal('create-server-modal')">
                    <div class="w-[48px] h-[48px] bg-discord-sidebar hover:bg-green-600 text-green-600 hover:text-white rounded-[50%] hover:rounded-[16px] transition-all flex items-center justify-center"><i data-lucide="plus" size="24"></i></div>
                </div>
                <div class="group cursor-pointer relative" onclick="window.app.toggleModal('join-server-modal')">
                    <div class="w-[48px] h-[48px] bg-discord-sidebar hover:bg-green-600 text-green-600 hover:text-white rounded-[50%] hover:rounded-[16px] transition-all flex items-center justify-center"><i data-lucide="compass" size="24"></i></div>
                </div>
            </nav>

            <!-- 2. SIDEBAR (Canales/Amigos) -->
            <div class="w-64 bg-discord-sidebar flex flex-col border-r border-gray-900/10">
                <div id="sidebar-header" class="h-12 border-b border-black/20 flex items-center px-4 font-bold shadow-sm hover:bg-white/5 cursor-pointer transition-colors justify-between relative overflow-hidden group shrink-0" onclick="window.app.openServerSettings()">
                    <div id="header-banner" class="absolute inset-0 bg-cover bg-center opacity-0 transition-opacity duration-300 z-0"></div>
                    <div class="absolute inset-0 bg-gradient-to-b from-black/10 to-black/60 z-0 group-hover:bg-black/40 transition-colors"></div>
                    <span id="header-title" class="truncate relative z-10 drop-shadow-md pr-2">Inicio</span>
                    <i data-lucide="chevron-down" size="16" id="header-icon" class="hidden relative z-10 drop-shadow-md"></i>
                </div>
                <div id="sidebar-content" class="flex-1 overflow-y-auto p-2 space-y-[2px]"></div>
                <!-- User Panel -->
                <div class="h-[52px] bg-[#232428] px-2 flex items-center justify-between shrink-0">
                    <div class="flex items-center group cursor-pointer p-1 rounded hover:bg-white/10 overflow-hidden mr-1" onclick="window.app.toggleModal('profile-modal')">
                        <div class="relative shrink-0"><img id="current-user-avatar" src="" class="w-8 h-8 rounded-full bg-gray-500 object-cover"><div id="current-user-status-dot" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[#232428]"></div></div>
                        <div class="ml-2 text-sm overflow-hidden"><div class="font-bold text-white leading-tight truncate" id="current-user-name">...</div><div class="text-xs text-gray-400 leading-tight" id="current-user-disc">#0000</div></div>
                    </div>
                    <div class="flex items-center shrink-0">
                        <button class="p-1.5 hover:bg-white/10 rounded text-gray-300 relative" onclick="window.app.toggleModal('push-info-modal')">
                            <i data-lucide="bell" size="18"></i>
                            <div id="push-status-dot" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
                        </button>
                        <button class="p-1.5 hover:bg-red-500/20 hover:text-red-400 rounded text-gray-300 transition-colors" onclick="window.app.logout()"><i data-lucide="log-out" size="18"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. MAIN CHAT AREA -->
        <main class="flex-1 flex flex-col min-w-0 bg-discord-chat relative w-full">
            <header class="h-12 border-b border-black/20 flex items-center justify-between px-4 shrink-0 shadow-sm z-30 bg-discord-chat">
                <div class="flex items-center text-white overflow-hidden">
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden mr-3 text-gray-300 hover:text-white" onclick="window.app.toggleMobileNav()">
                        <i data-lucide="menu" size="24"></i>
                    </button>
                    
                    <i data-lucide="message-square" class="text-gray-400 mr-2 shrink-0" id="chat-header-icon"></i>
                    <h3 class="font-bold mr-4 truncate" id="chat-header-name">Bienvenido</h3>
                    <span class="text-xs text-gray-400 border-l border-gray-600 pl-4 hidden sm:block truncate" id="chat-header-desc">Selecciona un canal</span>
                </div>
                <div class="flex items-center text-gray-300 space-x-3 shrink-0">
                    <i data-lucide="users" class="cursor-pointer hover:text-white" onclick="window.app.toggleMemberSidebar()"></i>
                </div>
            </header>
            
            <div id="messages-area" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth"></div>
            
            <div class="px-4 pb-6 pt-2 shrink-0">
                <div class="bg-[#383a40] rounded-lg p-2 sm:p-3 flex items-center shadow-sm">
                    <button class="text-gray-400 hover:text-white mr-2 sm:mr-3 shrink-0"><i data-lucide="plus-circle" size="24"></i></button>
                    <input type="text" id="message-input" class="bg-transparent flex-1 outline-none text-white placeholder-gray-400 min-w-0" placeholder="Chatear..." autocomplete="off" disabled>
                    <div class="hidden sm:flex text-gray-400 ml-2 space-x-2">
                        <i data-lucide="gift" size="20"></i>
                        <i data-lucide="sticker" size="20"></i>
                    </div>
                </div>
            </div>
        </main>

        <!-- 4. MEMBERS (Right Sidebar) -->
        <aside id="members-sidebar" class="absolute right-0 top-0 bottom-0 w-60 bg-discord-sidebar hidden flex-col border-l border-black/10 overflow-y-auto p-3 transition-all duration-300 z-40 shadow-xl"></aside>
    </div>

    <!-- MODALES -->
    <div id="create-server-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-white text-gray-800 w-full max-w-[440px] rounded-lg shadow-2xl p-6 animate-pop-in"><h2 class="text-2xl font-bold mb-4 text-center">Crear Servidor</h2><input type="text" id="new-server-name" class="w-full bg-gray-200 border-none rounded p-2 mb-6" placeholder="Nombre"><div class="flex justify-between"><button class="text-gray-600" onclick="window.app.toggleModal('create-server-modal')">Cancelar</button><button class="bg-[#5865F2] text-white px-6 py-2 rounded" onclick="window.app.createServer()">Crear</button></div></div></div>
    
    <div id="join-server-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-white text-gray-800 w-full max-w-[440px] rounded-lg shadow-2xl p-6 animate-pop-in"><h2 class="text-2xl font-bold text-center mb-4">Unirse</h2><input type="text" id="join-server-id" class="w-full bg-gray-200 border-none rounded p-2 mb-6" placeholder="ID del Servidor"><div class="flex justify-between"><button class="text-gray-600" onclick="window.app.toggleModal('join-server-modal')">Cancelar</button><button class="bg-[#23a559] text-white px-6 py-2 rounded" onclick="window.app.joinServer()">Unirse</button></div></div></div>
    
    <div id="create-channel-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-[#313338] text-gray-100 w-full max-w-[440px] rounded-lg shadow-2xl p-6 animate-pop-in"><h2 class="text-xl font-bold mb-4">Crear Canal</h2><input type="text" id="new-channel-name" class="w-full bg-[#1e1f22] text-white border-none rounded p-2 mb-6" placeholder="nuevo-canal"><div class="flex justify-between"><button class="text-gray-400" onclick="window.app.toggleModal('create-channel-modal')">Cancelar</button><button class="bg-[#5865F2] text-white px-6 py-2 rounded" onclick="window.app.createChannel()">Crear</button></div></div></div>
    
    <div id="add-friend-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-[#313338] text-gray-100 w-full max-w-[440px] rounded-lg shadow-2xl p-6 animate-pop-in"><h2 class="text-xl font-bold mb-2 text-white">Añadir Amigo</h2><input type="text" id="add-friend-input" class="w-full bg-[#1e1f22] text-white border-none rounded p-2 mb-6" placeholder="Ej: NeoUser"><div class="flex justify-between"><button class="text-gray-400" onclick="window.app.toggleModal('add-friend-modal')">Cancelar</button><button class="bg-green-600 text-white px-6 py-2 rounded" onclick="window.app.addFriend()">Enviar</button></div></div></div>
    
    <div id="profile-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-[#111214] w-full max-w-[600px] rounded-lg shadow-2xl overflow-hidden animate-pop-in"><div class="h-32 bg-indigo-500 relative"><div class="absolute -bottom-16 left-6 p-1 bg-[#111214] rounded-full group cursor-pointer" onclick="document.getElementById('avatar-input').click()"><img id="modal-avatar" src="" class="w-32 h-32 rounded-full object-cover bg-gray-600 group-hover:opacity-50 transition"><div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 font-bold text-white text-xs z-10 pointer-events-none">CAMBIAR</div><input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="window.app.handleImageUpload(this, 'avatar')"></div></div><div class="pt-20 px-6 pb-6"><h2 class="text-2xl font-bold text-white" id="modal-username">Usuario</h2><span class="text-gray-400 block mb-4" id="modal-discriminator">#0000</span><div class="mb-4 flex space-x-2"><button onclick="window.app.setStatus('online')" class="w-6 h-6 rounded-full bg-green-500"></button><button onclick="window.app.setStatus('idle')" class="w-6 h-6 rounded-full bg-yellow-500"></button><button onclick="window.app.setStatus('dnd')" class="w-6 h-6 rounded-full bg-red-500"></button><button onclick="window.app.setStatus('invisible')" class="w-6 h-6 rounded-full bg-gray-500"></button></div><div class="bg-[#2b2d31] rounded-lg p-4 mb-4"><textarea id="modal-about" class="w-full bg-transparent text-gray-200 resize-none outline-none h-20 border-b border-gray-700"></textarea></div><div class="text-right"><button class="bg-green-600 text-white px-4 py-2 rounded text-sm" onclick="window.app.saveProfile()">Guardar</button><button class="text-white ml-4" onclick="window.app.toggleModal('profile-modal')">Cerrar</button></div></div></div></div>

    <!-- Push Config Modal -->
    <div id="push-info-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-[#313338] w-full max-w-[500px] rounded-lg shadow-2xl p-6 animate-pop-in">
            <h2 class="text-xl font-bold text-white mb-4">Activar Notificaciones</h2>
            <div class="bg-[#2b2d31] p-4 rounded text-sm text-gray-300 mb-6 border border-gray-700">
                <p class="mb-4">Para recibir notificaciones cuando la app esté cerrada.</p>
                <div class="text-xs bg-black/20 p-2 rounded font-mono mb-2">Estado: <span id="push-status-text" class="text-yellow-400">Sin Permiso</span></div>
            </div>
            <div class="flex justify-end">
                <button class="bg-[#5865F2] text-white px-4 py-2 rounded text-sm" onclick="window.app.enablePushNotifications()">Activar</button>
                <button class="text-white ml-4" onclick="window.app.toggleModal('push-info-modal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Server Settings Modal (Responsive) -->
    <div id="server-settings-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-[#313338] w-full max-w-[800px] h-[90%] md:h-[600px] rounded flex flex-col md:flex-row shadow-2xl relative animate-pop-in overflow-hidden"><div class="w-full md:w-1/3 bg-[#2b2d31] p-4 border-b md:border-b-0 md:border-r border-[#1e1f22] flex flex-row md:flex-col justify-between md:justify-start gap-2 overflow-x-auto"><h2 class="font-bold text-gray-400 uppercase text-xs mb-0 md:mb-4 hidden md:block">Ajustes</h2><div onclick="window.app.switchSettingsTab('overview')" id="tab-btn-overview" class="text-white bg-[#404249] p-2 rounded text-sm cursor-pointer whitespace-nowrap">General</div><div onclick="window.app.switchSettingsTab('roles')" id="tab-btn-roles" class="text-gray-400 p-2 rounded text-sm cursor-pointer whitespace-nowrap">Roles</div><div class="md:mt-auto text-red-400 cursor-pointer text-sm font-bold flex items-center whitespace-nowrap" onclick="window.app.deleteServer()"><i data-lucide="trash-2" size="16" class="mr-2"></i> Eliminar</div></div><div class="flex-1 p-4 md:p-8 relative overflow-y-auto"><button class="absolute top-2 right-2 text-gray-400 hover:text-white" onclick="window.app.toggleModal('server-settings-modal')"><i data-lucide="x"></i></button><div id="settings-tab-overview" class="block"><h2 class="text-xl font-bold text-white mb-6">General</h2><div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6"><div class="relative group cursor-pointer shrink-0" onclick="document.getElementById('server-icon-input').click()"><div id="settings-server-icon" class="w-24 h-24 rounded-full bg-[#1e1f22] flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-500"><img id="settings-icon-preview" class="w-full h-full object-cover hidden"></div><input type="file" id="server-icon-input" class="hidden" accept="image/*" onchange="window.app.handleImageUpload(this, 'serverIcon')"></div><div class="w-full"><label class="text-xs font-bold text-gray-400 mb-2 block">Nombre</label><input type="text" id="settings-server-name" class="w-full bg-[#1e1f22] text-white p-2 rounded" onchange="window.app.saveServerOverview()"></div></div><div class="mt-8"><label class="text-xs font-bold text-gray-400 mb-2 block">Banner</label><div class="w-full h-32 bg-[#1e1f22] rounded border-2 border-dashed border-gray-600 relative overflow-hidden group cursor-pointer" onclick="document.getElementById('server-banner-input').click()"><img id="settings-banner-preview" class="absolute inset-0 w-full h-full object-cover hidden"><div class="z-10 text-gray-400 text-sm flex flex-col items-center justify-center h-full"><i data-lucide="image"></i></div><input type="file" id="server-banner-input" class="hidden" accept="image/*" onchange="window.app.handleImageUpload(this, 'serverBanner')"></div></div><div class="mt-8 pt-4 border-t border-gray-700 bg-black/20 p-2 rounded flex flex-col md:flex-row justify-between gap-2 overflow-hidden"><span id="settings-server-id" class="text-white font-mono text-xs select-all truncate">...</span><button class="text-indigo-400 text-xs shrink-0" onclick="window.app.copyServerId()">Copiar ID</button></div></div><div id="settings-tab-roles" class="hidden"><h2 class="text-xl font-bold text-white mb-2">Roles</h2><div class="flex flex-col md:flex-row h-[300px] md:h-[400px]"><div class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-gray-700 pr-2 overflow-y-auto mb-2 md:mb-0" id="roles-list-container"></div><div class="flex-1 pl-0 md:pl-4 overflow-y-auto" id="role-edit-panel"></div></div><button onclick="window.app.createNewRole()" class="absolute top-8 right-8 bg-[#5865F2] text-white px-3 py-1.5 rounded text-sm">Crear Rol</button></div></div></div></div>
    
    <div id="member-manage-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4"><div class="bg-[#313338] w-full max-w-[400px] rounded-lg shadow-2xl p-6"><h2 class="text-xl font-bold text-white mb-1" id="manage-member-name">Usuario</h2><div id="manage-member-roles" class="space-y-2 mb-6 max-h-40 overflow-y-auto"></div><div class="flex justify-end"><button class="text-white" onclick="window.app.toggleModal('member-manage-modal')">Listo</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, query, where, orderBy, updateDoc, arrayUnion, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

        // *** CONFIGURACIÓN ***
        const firebaseConfig = {
            apiKey: "AIzaSyAgDcx6L0kwAmdJbFEWT4-DStnmW5gT-yM",
            authDomain: "artix-9cc45.firebaseapp.com",
            databaseURL: "https://artix-9cc45-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "artix-9cc45",
            storageBucket: "artix-9cc45.firebasestorage.app",
            messagingSenderId: "756561772828",
            appId: "1:756561772828:web:13bfd0aca8879219823ad9"
        };
        const VAPID_KEY = "BMYpL90tCurWMNLFZ465QiIMIwk41fkY73k6O9e4wcvlfHzXGAwzkPjpdzQluiCdH7KEXeRhZ4DpHYVaU0tfCuk";
        const WORKER_URL = "https://artixp.logise1123.workers.dev/";
        const appId = "artix-v2";

        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        let messaging;

        // Path Helpers
        const getPubColl = (c) => collection(db, 'artifacts', appId, 'public', 'data', c);
        const getPubDoc = (c, d) => doc(db, 'artifacts', appId, 'public', 'data', c, d);
        const getPubSubColl = (path, sub) => collection(db, 'artifacts', appId, 'public', 'data', ...path, sub);
        const getPubRoleDoc = (sid, rid) => doc(db, 'artifacts', appId, 'public', 'data', 'servers', sid, 'roles', rid);
        const getPubChannelDoc = (sid, cid) => doc(db, 'artifacts', appId, 'public', 'data', 'servers', sid, 'channels', cid);
        const getPubMemberDoc = (sid, mid) => doc(db, 'artifacts', appId, 'public', 'data', 'servers', sid, 'members', mid);

        const appState = {
            user: null, activeServer: null, activeChannel: null, view: 'home',
            cache: {}, subs: {}, pendingUpload: {}, myMember: null, editingRoleId: null
        };

        const app = {
            init: () => {
                lucide.createIcons();
                try {
                    messaging = getMessaging(appInstance);
                    onMessage(messaging, (payload) => {
                        console.log('Push:', payload);
                        new Notification(payload.notification.title, { body: payload.notification.body, icon: payload.notification.icon });
                    });
                } catch(e) { console.log("Msg init error", e); }

                onAuthStateChanged(auth, u => {
                    if(u) { appState.user = u; app.showApp(); app.listenUser(); } 
                    else { app.showLogin(); app.clearSubs(); }
                });
                document.getElementById('auth-form').addEventListener('submit', app.handleAuth);
                document.getElementById('auth-toggle-btn').onclick = (e) => { e.preventDefault(); app.toggleAuthMode(); };
                document.getElementById('message-input').onkeypress = (e) => { if(e.key === 'Enter') app.sendMessage(); };
            },

            // --- MOBILE NAV ---
            toggleMobileNav: () => {
                const nav = document.getElementById('main-navigation');
                const overlay = document.getElementById('mobile-overlay');
                if (nav.classList.contains('-translate-x-full')) {
                    nav.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    nav.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },

            // --- PUSH ---
            enablePushNotifications: async () => {
                try {
                    document.getElementById('push-status-text').innerText = "Solicitando...";
                    const p = await Notification.requestPermission();
                    if (p === 'granted') {
                        const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                        if (token) {
                            await updateDoc(getPubDoc('users', appState.user.uid), { fcmToken: token });
                            document.getElementById('push-status-text').innerText = "Activado";
                            document.getElementById('push-status-text').className = "text-green-400";
                            document.getElementById('push-status-dot').className = "absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full";
                        }
                    } else document.getElementById('push-status-text').innerText = "Denegado";
                } catch (e) { document.getElementById('push-status-text').innerText = "Error"; console.error(e); }
            },

            // --- ACTIONS ---
            sendMessage: async () => {
                const inp = document.getElementById('message-input'); const txt = inp.value.trim();
                if(!txt || !appState.activeChannel) return;
                if((txt.includes('@everyone')||txt.includes('@here')) && !app.checkPermission('MENTION')) return alert("Sin permiso");
                inp.value = '';
                const sName = document.getElementById('header-title').innerText;
                const cName = document.getElementById('chat-header-name').innerText;
                
                await addDoc(getPubSubColl(['servers', appState.activeServer, 'channels', appState.activeChannel], 'messages'), { 
                    content: txt, userId: appState.user.uid, timestamp: serverTimestamp() 
                });

                const membersSnap = await getDocs(getPubSubColl(['servers', appState.activeServer], 'members'));
                membersSnap.forEach(async (memDoc) => {
                    const mData = memDoc.data();
                    if (mData.uid === appState.user.uid) return;
                    const uSnap = await getDoc(getPubDoc('users', mData.uid));
                    if (uSnap.exists()) {
                        const uData = uSnap.data();
                        if (uData.fcmToken) {
                            fetch(WORKER_URL, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ fcmToken: uData.fcmToken, title: `Artix: ${sName} (#${cName})`, body: `${appState.userData.username}: ${txt}` })
                            }).catch(e=>{});
                        }
                    }
                });
            },

            // --- AUTH ---
            toggleAuthMode: () => {
                const btn = document.getElementById('auth-submit-btn');
                const isLogin = btn.innerText === 'Entrar';
                btn.innerText = isLogin ? 'Registrarse' : 'Entrar';
                document.querySelector('#auth-screen h1').innerText = isLogin ? 'Crear Cuenta' : 'Artix v3.0';
            },
            handleAuth: async (e) => {
                e.preventDefault();
                const u = document.getElementById('auth-username').value.trim();
                const p = document.getElementById('auth-password').value;
                const email = `${u}@artix.com`;
                try {
                    if(document.getElementById('auth-submit-btn').innerText === 'Registrarse') {
                        const c = await createUserWithEmailAndPassword(auth, email, p);
                        await setDoc(getPubDoc('users', c.user.uid), {
                            username: u, discriminator: '#'+c.user.uid.substr(0,4).toUpperCase(),
                            avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${u}`, status: 'online', friends: [], joinedServers: []
                        });
                    } else await signInWithEmailAndPassword(auth, email, p);
                } catch(err) { document.getElementById('auth-error').innerText = err.message; document.getElementById('auth-error').classList.remove('hidden'); }
            },
            logout: async () => { try { await signOut(auth); window.location.reload(); } catch(e) { window.location.reload(); } },

            // --- DATA ---
            listenUser: () => {
                if(appState.subs.user) appState.subs.user();
                appState.subs.user = onSnapshot(getPubDoc('users', appState.user.uid), s => {
                    if(s.exists()) {
                        const d = s.data(); appState.userData = d; app.updateUserUI(d); app.loadServerList(d.joinedServers||[]);
                        if(appState.view === 'home') app.renderHome();
                    }
                });
            },
            updateUserUI: (d) => {
                document.getElementById('current-user-name').innerText = d.username;
                document.getElementById('current-user-disc').innerText = d.discriminator;
                document.getElementById('current-user-avatar').src = d.avatar;
                if(!appState.pendingUpload.avatar) document.getElementById('modal-avatar').src = d.avatar;
                if(d.fcmToken) {
                    document.getElementById('push-status-text').innerText = "Activado";
                    document.getElementById('push-status-text').className = "text-green-400";
                    document.getElementById('push-status-dot').className = "absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full";
                }
            },
            loadServerList: (ids) => {
                const list = document.getElementById('server-list'); list.innerHTML = '';
                ids.forEach(id => {
                    onSnapshot(getPubDoc('servers', id), s => {
                        if(!s.exists()) return;
                        const d = s.data(); const active = appState.activeServer === id;
                        let div = document.getElementById(`srv-${id}`);
                        const icon = d.icon ? `<img src="${d.icon}" class="w-full h-full object-cover rounded-[50%] group-hover:rounded-[16px] transition-all">` : `<div class="w-full h-full bg-[#313338] text-gray-200 group-hover:bg-[${d.color||'#5865F2'}] rounded-[50%] group-hover:rounded-[16px] transition-all flex items-center justify-center font-medium">${d.name.substring(0,2).toUpperCase()}</div>`;
                        const html = `<div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-[4px]"><div class="server-pill w-full bg-white rounded-r-lg ${active?'h-[40px]':'h-[8px] opacity-0 group-hover:opacity-100'}"></div></div><div class="server-placeholder w-[48px] h-[48px] transition-all duration-200">${icon}</div>`;
                        if(!div) { div = document.createElement('div'); div.id = `srv-${id}`; div.className = `server-icon-wrapper relative group cursor-pointer ${active?'active-server':''}`; div.onclick = () => app.selectServer(id, d); div.innerHTML = html; list.appendChild(div); }
                        else { div.innerHTML = html; div.className = `server-icon-wrapper relative group cursor-pointer ${active?'active-server':''}`; }
                    });
                });
            },
            selectServer: (id, data) => {
                appState.view = 'server'; appState.activeServer = id; appState.serverData = data;
                document.querySelectorAll('.active-server').forEach(e => e.classList.remove('active-server'));
                document.getElementById('pill-home').classList.remove('opacity-100', 'h-[40px]');
                const el = document.getElementById(`srv-${id}`); if(el) el.classList.add('active-server');
                document.getElementById('header-title').innerText = data.name;
                document.getElementById('header-icon').classList.remove('hidden');
                document.getElementById('header-banner').style.opacity = data.banner ? '1' : '0';
                if(data.banner) document.getElementById('header-banner').style.backgroundImage = `url(${data.banner})`;
                if(appState.subs.channels) appState.subs.channels();
                appState.subs.channels = onSnapshot(getPubSubColl(['servers', id], 'channels'), snap => app.renderChannelList(snap));
                app.loadRoles(id); app.loadMembers(id);
                // Mobile: Don't auto close nav on server switch, let user pick channel
            },
            renderChannelList: (snap) => {
                const sb = document.getElementById('sidebar-content'); const canManage = app.checkPermission('CHANNELS');
                sb.innerHTML = `<div class="px-2 pt-4 pb-1 text-xs font-bold text-gray-400 uppercase flex justify-between items-center group"><span class="flex items-center"><i data-lucide="chevron-down" size="12" class="mr-1"></i> Canales</span>${canManage?`<i data-lucide="plus" size="14" class="cursor-pointer hover:text-white" onclick="window.app.toggleModal('create-channel-modal')"></i>`:''}</div>`;
                let chans = []; snap.forEach(d => chans.push({id: d.id, ...d.data()}));
                chans.sort((a,b) => { if(a.name === 'general') return -1; if(b.name === 'general') return 1; return (a.order||0) - (b.order||0); });
                let first = null;
                chans.forEach((c, idx) => {
                    if(!first) first = c.id;
                    const active = appState.activeChannel === c.id;
                    const div = document.createElement('div');
                    div.className = `group flex items-center justify-between px-2 py-1 mx-2 rounded cursor-pointer transition-colors ${active?'bg-[#3f4147] text-white':'text-gray-400 hover:bg-[#35373c] hover:text-gray-200'} mb-0.5 relative`;
                    div.onclick = (e) => { if(!e.target.closest('.action-btn')) app.selectChannel(c.id, c.name); };
                    let btns = '';
                    if(canManage) {
                        btns = `<div class="hidden group-hover:flex items-center absolute right-2 bg-[#2b2d31] rounded shadow">
                            ${idx>0 && c.name!=='general' ? `<button class="action-btn p-1 hover:text-white" onclick="window.app.moveChannel('${c.id}',-1)"><i data-lucide="arrow-up" size="14"></i></button>`:''}
                            ${idx<chans.length-1 ? `<button class="action-btn p-1 hover:text-white" onclick="window.app.moveChannel('${c.id}',1)"><i data-lucide="arrow-down" size="14"></i></button>`:''}
                            ${c.name!=='general' ? `<button class="action-btn p-1 hover:text-red-500" onclick="window.app.deleteChannel(event, '${c.id}')"><i data-lucide="trash-2" size="14"></i></button>`:''}
                        </div>`;
                    }
                    div.innerHTML = `<div class="flex items-center overflow-hidden"><i data-lucide="hash" size="18" class="mr-1.5 text-gray-500 shrink-0"></i><span class="font-medium truncate">${c.name}</span></div>${btns}`;
                    sb.appendChild(div);
                });
                lucide.createIcons();
                if(first && !appState.activeChannel) app.selectChannel(first, "general");
            },
            selectChannel: (cid, name) => {
                if(appState.activeChannel) { const o = document.getElementById(`chan-${appState.activeChannel}`); if(o) o.classList.remove('bg-[#3f4147]', 'text-white'); }
                appState.activeChannel = cid;
                document.getElementById('chat-header-name').innerText = name;
                document.getElementById('message-input').disabled = false;
                document.getElementById('message-input').placeholder = `Mensaje en #${name}`;
                // MOBILE: Close Nav on selection
                if(window.innerWidth < 768) app.toggleMobileNav();

                if(appState.subs.msgs) appState.subs.msgs();
                appState.subs.msgs = onSnapshot(query(getPubSubColl(['servers', appState.activeServer, 'channels', cid], 'messages'), orderBy('timestamp')), snap => {
                    const area = document.getElementById('messages-area'); area.innerHTML = '';
                    if(snap.empty) { area.innerHTML = `<div class="mt-10 mx-4"><div class="w-16 h-16 bg-[#41434a] rounded-full flex items-center justify-center mb-4"><i data-lucide="hash" size="40" class="text-white"></i></div><h1 class="text-3xl font-bold text-white mb-2">Bienvenido a #${name}</h1></div>`; lucide.createIcons(); return; }
                    snap.forEach(async d => {
                        const m = d.data();
                        const u = await app.fetchUser(m.userId);
                        const date = m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...';
                        const div = document.createElement('div');
                        div.className = "flex mt-1 py-1 px-2 hover:bg-black/5 group";
                        let txt = m.content.replace(/&/g, "&amp;").replace(/</g, "&lt;");
                        txt = txt.replace(/(@everyone|@here)/g, '<span class="mention mention-everyone">$1</span>');
                        if(appState.roles) Object.values(appState.roles).forEach(r => { txt = txt.replace(new RegExp(`@${r.name}\\b`,'g'), `<span class="mention" style="color:${r.color};bg:${r.color}20">@${r.name}</span>`); });
                        div.innerHTML = `<img src="${u.avatar}" class="w-10 h-10 rounded-full mr-4 bg-gray-600"><div class="flex-1 min-w-0"><div class="flex items-center"><span class="font-medium text-white mr-2 truncate">${u.username}</span><span class="text-xs text-gray-500">${date}</span></div><div class="text-gray-300 break-all">${txt}</div></div>`;
                        area.appendChild(div);
                    });
                    setTimeout(() => area.scrollTop = area.scrollHeight, 100);
                });
            },
            createChannel: async () => { const name = document.getElementById('new-channel-name').value.trim(); if(!name) return; await addDoc(getPubSubColl(['servers', appState.activeServer], 'channels'), { name, type: 'text', order: Date.now() }); app.toggleModal('create-channel-modal'); },
            deleteChannel: async (e, cid) => { if(e) e.stopPropagation(); if(confirm("¿Borrar canal?")) await deleteDoc(getPubChannelDoc(appState.activeServer, cid)); },
            moveChannel: async (cid, dir) => { const snap = await getDocs(query(getPubSubColl(['servers', appState.activeServer], 'channels'), orderBy('order'))); const chans = snap.docs.map(d=>({id:d.id, ...d.data(), order:d.data().order||0})); chans.sort((a,b) => a.order - b.order); const idx = chans.findIndex(c=>c.id===cid); if(idx<0) return; const target = idx + dir; if(target>=0 && target<chans.length && chans[target].name !== 'general' && chans[idx].name !== 'general') { await updateDoc(getPubChannelDoc(appState.activeServer, chans[idx].id), {order: chans[target].order}); await updateDoc(getPubChannelDoc(appState.activeServer, chans[target].id), {order: chans[idx].order}); } },
            checkPermission: (p) => { if(!appState.activeServer || appState.serverData.ownerId === appState.user.uid) return true; if(!appState.myMember || !appState.myMember.roleId) return false; const r = appState.roles[appState.myMember.roleId]; return r && (r.permissions.includes('ADMIN') || r.permissions.includes(p)); },
            loadRoles: (sid) => { if(appState.subs.roles) appState.subs.roles(); appState.subs.roles = onSnapshot(getPubSubColl(['servers', sid], 'roles'), s => { appState.roles = {}; const c = document.getElementById('roles-list-container'); if(c) c.innerHTML = ''; s.forEach(d => { const r = d.data(); appState.roles[d.id] = r; if(c) { const div = document.createElement('div'); div.className = "flex justify-between p-2 hover:bg-[#35373c] rounded mb-1 cursor-pointer"; div.onclick = () => app.editRole(d.id, r); div.innerHTML = `<div class="flex items-center"><div class="w-3 h-3 rounded-full mr-2" style="background-color:${r.color}"></div><span class="text-white text-sm">${r.name}</span></div><i data-lucide="chevron-right" size="14"></i>`; c.appendChild(div); } }); app.loadMembers(sid); }); },
            loadMembers: (sid) => { if(appState.subs.members) appState.subs.members(); appState.subs.members = onSnapshot(getPubSubColl(['servers', sid], 'members'), async s => { const sb = document.getElementById('members-sidebar'); sb.innerHTML = ''; const mems = []; for(const d of s.docs) { const m=d.data(); if(m.uid===appState.user.uid) appState.myMember=m; mems.push({id:d.id, ...m, user: await app.fetchUser(m.uid)}); } const h = document.createElement('h3'); h.className = 'text-xs font-bold text-gray-500 mt-4 mb-2 px-2'; h.innerText = `MIEMBROS — ${mems.length}`; sb.appendChild(h); mems.forEach(m => { const r = m.roleId ? appState.roles[m.roleId] : null; const div = document.createElement('div'); div.className = 'flex items-center px-2 py-1.5 rounded hover:bg-[#35373c] cursor-pointer mb-1'; div.onclick = () => app.openMemberManage(m); div.innerHTML = `<div class="relative mr-3"><img src="${m.user.avatar}" class="w-8 h-8 rounded-full"><div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[#2b2d31] bg-green-500"></div></div><div><div class="font-medium" style="color:${r?r.color:'#99AAB5'}">${m.user.username}</div><div class="text-xs text-gray-400">${r?r.name:''}</div></div>`; sb.appendChild(div); }); }); },
            openMemberManage: (m) => { if(appState.serverData.ownerId !== appState.user.uid) return; document.getElementById('manage-member-name').innerText = m.user.username; const c = document.getElementById('manage-member-roles'); c.innerHTML = ''; Object.entries(appState.roles).forEach(([rid, r]) => { const div = document.createElement('div'); div.className = "flex justify-between p-2 bg-[#1e1f22] rounded mb-1"; div.innerHTML = `<span style="color:${r.color}">${r.name}</span><input type="checkbox" ${m.roleId===rid?'checked':''} onchange="window.app.setMemberRole('${m.id}','${rid}',this.checked)">`; c.appendChild(div); }); app.toggleModal('member-manage-modal'); },
            setMemberRole: async (mid, rid, checked) => await updateDoc(getPubMemberDoc(appState.activeServer, mid), { roleId: checked ? rid : null }),
            editRole: (rid, r) => { appState.editingRoleId = rid; const p = document.getElementById('role-edit-panel'); const chk = (perm) => (r.permissions||[]).includes(perm) ? 'checked' : ''; p.innerHTML = `<div class="mb-4"><label class="text-xs font-bold text-gray-400">Nombre</label><input type="text" id="edit-role-name" value="${r.name}" class="w-full bg-[#1e1f22] text-white p-2 rounded" onchange="window.app.saveRoleChanges()"></div><div class="mb-4"><label class="text-xs font-bold text-gray-400">Color</label><input type="color" id="edit-role-color" value="${r.color}" class="w-full h-8 bg-transparent" onchange="window.app.saveRoleChanges()"></div><div class="space-y-2"><label class="flex items-center text-gray-300"><input type="checkbox" id="ep-admin" ${chk('ADMIN')} onchange="window.app.saveRoleChanges()" class="mr-2"> Admin</label><label class="flex items-center text-gray-300"><input type="checkbox" id="ep-chan" ${chk('CHANNELS')} onchange="window.app.saveRoleChanges()" class="mr-2"> Canales</label><label class="flex items-center text-gray-300"><input type="checkbox" id="ep-men" ${chk('MENTION')} onchange="window.app.saveRoleChanges()" class="mr-2"> Menciones</label></div><div class="mt-4"><button class="text-red-400 text-sm" onclick="window.app.deleteRole('${rid}')">Eliminar Rol</button></div>`; },
            saveRoleChanges: async () => { if(!appState.editingRoleId) return; const perms = []; if(document.getElementById('ep-admin').checked) perms.push('ADMIN'); if(document.getElementById('ep-chan').checked) perms.push('CHANNELS'); if(document.getElementById('ep-men').checked) perms.push('MENTION'); await updateDoc(getPubRoleDoc(appState.activeServer, appState.editingRoleId), { name: document.getElementById('edit-role-name').value, color: document.getElementById('edit-role-color').value, permissions: perms }); },
            createNewRole: async () => await addDoc(getPubSubColl(['servers', appState.activeServer], 'roles'), { name: 'New Role', color: '#999', permissions: [] }),
            deleteRole: async (rid) => { await deleteDoc(getPubRoleDoc(appState.activeServer, rid)); document.getElementById('role-edit-panel').innerHTML=''; },
            createServer: async () => { const name = document.getElementById('new-server-name').value; if(!name) return; const s = await addDoc(getPubColl('servers'), { name, ownerId: appState.user.uid, color: '#7289da' }); await addDoc(getPubSubColl(['servers', s.id], 'channels'), { name: 'general', type: 'text', order: 0 }); const r = await addDoc(getPubSubColl(['servers', s.id], 'roles'), { name: 'Admin', color: '#E91E63', permissions: ['ADMIN'] }); await addDoc(getPubSubColl(['servers', s.id], 'members'), { uid: appState.user.uid, roleId: r.id }); await updateDoc(getPubDoc('users', appState.user.uid), { joinedServers: arrayUnion(s.id) }); app.toggleModal('create-server-modal'); },
            joinServer: async () => { const id = document.getElementById('join-server-id').value; const s = await getDoc(getPubDoc('servers', id)); if(s.exists()) { await addDoc(getPubSubColl(['servers', id], 'members'), { uid: appState.user.uid, roleId: null }); await updateDoc(getPubDoc('users', appState.user.uid), { joinedServers: arrayUnion(id) }); app.toggleModal('join-server-modal'); } else alert("Server no existe"); },
            deleteServer: async () => { if(confirm("¿Eliminar servidor?")) { await deleteDoc(getPubDoc('servers', appState.activeServer)); app.loadHome(); app.toggleModal('server-settings-modal'); } },
            handleImageUpload: (input, type) => { if(input.files[0]) { const r = new FileReader(); r.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const cvs = document.createElement('canvas'); const w = type==='serverBanner'?400: (type==='serverIcon'?128:64); const h = type==='serverBanner'?225: (type==='serverIcon'?128:64); cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h); const b64 = cvs.toDataURL('image/jpeg', 0.8); appState.pendingUpload[type] = b64; if(type==='avatar') document.getElementById('modal-avatar').src = b64; if(type==='serverIcon') { document.getElementById('settings-icon-preview').src=b64; document.getElementById('settings-icon-preview').classList.remove('hidden'); app.saveServerOverview(); } if(type==='serverBanner') { document.getElementById('settings-banner-preview').src=b64; document.getElementById('settings-banner-preview').classList.remove('hidden'); app.saveServerOverview(); } } }; r.readAsDataURL(input.files[0]); } },
            saveProfile: async () => { const u = { about: document.getElementById('modal-about').value }; if(appState.pendingUpload.avatar) { u.avatar = appState.pendingUpload.avatar; appState.pendingUpload.avatar=null; } await updateDoc(getPubDoc('users', appState.user.uid), u); app.toggleModal('profile-modal'); },
            saveServerOverview: async () => { const u = { name: document.getElementById('settings-server-name').value }; if(appState.pendingUpload.serverIcon) { u.icon=appState.pendingUpload.serverIcon; appState.pendingUpload.serverIcon=null; } if(appState.pendingUpload.serverBanner) { u.banner=appState.pendingUpload.serverBanner; appState.pendingUpload.serverBanner=null; } await updateDoc(getPubDoc('servers', appState.activeServer), u); },
            fetchUser: async (uid) => { if(appState.cache[uid]) return appState.cache[uid]; const s = await getDoc(getPubDoc('users', uid)); const data = s.exists() ? s.data() : {username:'?', avatar:'', status:'offline'}; appState.cache[uid] = data; return data; },
            setStatus: async (s) => { await updateDoc(getPubDoc('users', appState.user.uid), {status:s}); },
            copyServerId: () => { navigator.clipboard.writeText(appState.activeServer); alert("ID Copiado!"); },
            showApp: () => { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app').classList.remove('opacity-0', 'pointer-events-none'); },
            showLogin: () => { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('app').classList.add('opacity-0', 'pointer-events-none'); },
            toggleModal: (id) => { const m = document.getElementById(id); if(id === 'profile-modal') { const d = appState.userData; document.getElementById('modal-username').innerText = d.username; document.getElementById('modal-discriminator').innerText = d.discriminator; document.getElementById('modal-avatar').src = d.avatar; document.getElementById('modal-about').value = d.about || ''; appState.pendingUpload.avatar = null; } m.classList.toggle('hidden'); },
            openServerSettings: () => { if(appState.view !== 'server') return; app.switchSettingsTab('overview'); document.getElementById('settings-server-id').innerText = appState.activeServer; app.toggleModal('server-settings-modal'); },
            toggleMemberSidebar: () => { const sb = document.getElementById('members-sidebar'); sb.classList.toggle('hidden'); sb.classList.toggle('flex'); sb.classList.toggle('absolute'); sb.classList.toggle('right-0'); sb.classList.toggle('z-50'); sb.classList.toggle('h-full'); },
            switchSettingsTab: (t) => { document.querySelectorAll('[id^="settings-tab-"]').forEach(el => el.classList.add('hidden')); document.getElementById(`settings-tab-${t}`).classList.remove('hidden'); document.querySelectorAll('[id^="tab-btn-"]').forEach(el => { el.classList.remove('bg-[#404249]', 'text-white'); el.classList.add('text-gray-400'); }); document.getElementById(`tab-btn-${t}`).classList.add('bg-[#404249]', 'text-white'); },
            loadHome: () => { appState.view = 'home'; appState.activeServer = null; appState.activeChannel = null; document.querySelectorAll('.active-server').forEach(e => e.classList.remove('active-server')); document.getElementById('pill-home').classList.add('opacity-100', 'h-[40px]'); document.getElementById('header-title').innerText = "Amigos"; document.getElementById('header-icon').classList.add('hidden'); document.getElementById('messages-area').innerHTML = ''; document.getElementById('members-sidebar').innerHTML = ''; document.getElementById('message-input').disabled = true; document.getElementById('header-banner').style.opacity = '0'; app.renderHome(); },
            renderHome: async () => { const sb = document.getElementById('sidebar-content'); sb.innerHTML = `<div class="px-2 pt-4 pb-2 text-xs font-bold text-gray-400 uppercase flex justify-between items-center"><span>Mensajes Directos</span><i data-lucide="plus" class="cursor-pointer hover:text-white" onclick="window.app.toggleModal('add-friend-modal')"></i></div>`; const friends = appState.userData.friends || []; for(const fid of friends) { const fData = await app.fetchUser(fid); const div = document.createElement('div'); div.className = "flex items-center p-2 rounded cursor-pointer hover:bg-[#35373c] text-gray-400 hover:text-gray-200 mx-2 mb-1 group"; div.innerHTML = `<div class="relative mr-3"><img src="${fData.avatar}" class="w-8 h-8 rounded-full"><div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-[#2b2d31] ${app.getStatusColor(fData.status)}"></div></div><span class="font-bold text-white truncate flex-1">${fData.username}</span><i data-lucide="message-square" class="opacity-0 group-hover:opacity-100 w-4 h-4"></i>`; sb.appendChild(div); } lucide.createIcons(); },
            addFriend: async () => { const name = document.getElementById('add-friend-input').value.trim(); if(!name) return; const q = query(getPubColl('users'), where('username', '==', name)); const snap = await getDocs(q); if(snap.empty) { alert("Usuario no encontrado."); } else { const friendId = snap.docs[0].id; if(friendId === appState.user.uid) return alert("No puedes añadirte a ti mismo."); await updateDoc(getPubDoc('users', appState.user.uid), { friends: arrayUnion(friendId) }); app.toggleModal('add-friend-modal'); document.getElementById('add-friend-input').value = ''; } },
            clearSubs: () => Object.values(appState.subs).forEach(f=>f&&f())
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>
